---
# CI/CD Pipeline: Lint and test code on every push/PR
# Workflow visualization: setup â†’ (lint + test run in parallel)
name: CI/CD

# "on" is linter safe since it's a reserved word in YAML
"on":
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]
  # Manual trigger option - appears as separate job in UI because it has no dependencies
  workflow_dispatch:
    inputs:
      logLevel:
        description: "Log level"
        required: true
        default: "warning"
        type: choice
        options:
          - info
          - warning
          - debug

jobs:
  # ============================================================================
  # SETUP: Install dependencies once, share with all other jobs
  # This job creates the foundation - other jobs depend on it
  # ============================================================================
  setup:
    name: Setup Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js 18
        uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: "npm"

      # Cache both node_modules AND Cypress binary for maximum speed
      - name: Cache node-modules
        uses: actions/cache@v3
        id: cache-node-modules
        with:
          path: |
            node_modules
            ~/.cache/Cypress
          key: node-modules-${{ runner.os }}-${{ hashFiles('package-lock.json') }}

      # Only install if cache miss (usually only on first run or package changes)
      - name: Install dependencies
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        run: npm ci

  # ============================================================================
  # LINT: Check code style and quality
  # Runs in parallel with 'test' after 'setup' completes
  # ============================================================================
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js 18
        uses: actions/setup-node@v3
        with:
          node-version: 18
      # Restore node_modules and Cypress binary rom setup job
      - name: Restore node_modules and Cypress binary
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            ~/.cache/Cypress
          key: node-modules-${{ runner.os }}-${{ hashFiles('package-lock.json') }}

      - name: Run linter
        run: |
          npm run lint:js
          npm run lint:yaml

  # ============================================================================
  # TEST: Run Cypress E2E tests across multiple browsers
  # Matrix creates separate jobs for each browser (chrome, firefox, safari, edge)
  # All browser tests run in parallel after 'setup' completes
  # ============================================================================
  test:
    name: E2E Tests (${{ matrix.browser }})
    runs-on: ubuntu-latest
    needs: setup
    strategy:
      matrix:
        browser: [chrome, firefox]
      # Don't cancel other browser tests if one fails - see all results
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js 18
        uses: actions/setup-node@v3
        with:
          node-version: 18

      # Restore node_modules and Cypress binary from setup job
      - name: Restore node_modules and Cypress binary
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            ~/.cache/Cypress
          key: node-modules-${{ runner.os }}-${{ hashFiles('package-lock.json') }}

      # Run Cypress tests on a specified browser (retries once on failure)
      - name: Run Cypress E2E on ${{ matrix.browser }}
        uses: cypress-io/github-action@v7
        with:
          install: false # skip install, restoring from cache
          browser: ${{ matrix.browser }}
          # start parameter is used for starting the server, json-server is required for booklist tests
          # start: npm run server
          # command parameter overwrites the Cypress run command with your custom command
          command: npm run cy:run

      # Save screenshots only when tests fail (for debugging)
      # Include browser name in artifact so they don't overwrite each other
      - name: Upload test failure screenshots
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: cypress-screenshots-${{ matrix.browser }}
          path: cypress/screenshots
          if-no-files-found: ignore

  # ============================================================================
  # MANUAL TRIGGER: Debug logging (only runs on workflow_dispatch)
  # Independent job - shows separately in UI
  # ============================================================================
  manual-trigger:
    name: Manual Workflow Trigger
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    steps:
      - name: Log manual trigger info
        run: |
          echo "Manual workflow triggered."
          echo "Log level: $LEVEL"
        env:
          LEVEL: ${{ inputs.logLevel }}
